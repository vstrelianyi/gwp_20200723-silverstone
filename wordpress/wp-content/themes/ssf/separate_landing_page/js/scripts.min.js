// MODAL SCRIPT

// Detect ios 11_0_x affected
// NEED TO BE UPDATED if new versions are affected
var ua = navigator.userAgent,
    iOS = /iPad|iPhone|iPod/.test(ua),
//	iOS11 = /OS 11_0_1|OS 11_0_2|OS 11_0_3/.test(ua),
    iOS11 = /OS 11_(\d+)_?(\d+)?/.test(ua),
    scrolledPositionBeforeOpenModal;

// ios 11 bug caret position
if ( iOS && iOS11 ) {
    // Add CSS class to body
    $("body").addClass("iosBugFixCaret");


}

if(/Android/.test(navigator.appVersion)) {
    window.addEventListener("resize", function() {
        if(document.activeElement.tagName=="INPUT" || document.activeElement.tagName=="TEXTAREA") {
            document.activeElement.scrollIntoView();
        }
    });
}

var block = $('<div>').css({'height':'50px','width':'50px'}),
    indicator = $('<div>').css({'height':'200px'}),
    scrollbarWidth = 0;

$('body').append(block.append(indicator));
var w1 = $('div', block).innerWidth();
block.css('overflow-y', 'scroll');
var w2 = $('div', block).innerWidth();
$(block).remove();
scrollbarWidth = (w1 - w2);


function openModal(hrefModal) {

    if ( iOS && iOS11 ) {
        scrolledPositionBeforeOpenModal = $(document).scrollTop();
    }

    if (scrollbarWidth > 0) {
        $('body, .page-header').css('padding-right', scrollbarWidth);
    }

    $(hrefModal).fadeIn(200);

    $('body').addClass('modal-opened');

}


function closeModals() {

    if (scrollbarWidth > 0) {
        $('.popup-block:not(:hidden)').fadeOut(200, function() {
            $('body, .page-header').css('padding-right', 0);
            $('body, html').removeClass('modal-opened');

            if ( iOS && iOS11 ) {
                $('html, body').scrollTop(scrolledPositionBeforeOpenModal);
            }
        });
    } else {
        $('body, .page-header').css('padding-right', 0);
        $('body, html').removeClass('modal-opened');

        if ( iOS && iOS11 ) {
            $('html, body').scrollTop(scrolledPositionBeforeOpenModal);
        }

        $('.popup-block:not(:hidden)').fadeOut(200);
    }
}

function showThanksModal() {
    $('.popup-block:not(:hidden)').fadeOut(200);

    $('#thanks-popup').fadeIn(200);
}

$('[data-toggle="modal"]').click(function(e) {
    e.preventDefault();

    var hrefModal = $(this).attr('data-target');

    openModal(hrefModal);
});

$('[data-toggle="dismiss"]').click(function(e) {
    e.preventDefault();

    closeModals();
});

$('.popup-block__overlay').click(function(e) {
    var closeButton = $('[data-toggle="dismiss"]');

    if (e.target != this) {
//		return false;
    } else {
        closeModals();
    }
});

$('[data-toggle="dismiss"]').click(function(e) {
    e.preventDefault();

    closeModals();
});

$('.brand-mobile-slider').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    initialSlide: 0,
    arrows: false,
    dots: true,
    infinite: true,
    mobileFirst: true,
    variableWidth: true,
    centerMode: true,
    centerPadding: '30px',
    responsive: [
        {
            breakpoint: 767,
            settings: 'unslick'
        }
    ]

});

$(window).on('resize orientationchange', function() {
    $('.brand-mobile-slider').slick('resize');
});

$('.text-input').on('focusin', function() {
    $(this).parent().addClass('focused');
});

$('.text-input').on('focusout', function() {
    $(this).parent().removeClass('focused');
});

$('.count-block').counterUp({
    time: 1600,
    formatter: function (n) {
        return n.replace(/,/g, ' ');
    }
});


$('[data-toggle="anchor"]').click(function(e) {
    e.preventDefault();

    var dataTarget = $(this).attr('data-target'),
        targetPos;

    if ($(window).width() > 1199) {
        targetPos = $(dataTarget).offset().top - 90;
    }

    if ($(window).width() > 767 && $(window).width() < 1200) {
        targetPos = $(dataTarget).offset().top - 139;
    }

    if ($(window).width() < 768) {
        targetPos = $(dataTarget).offset().top - 79;
    }


    $('html,body').animate({
        scrollTop: targetPos
    }, 400);

});

// $('.submit-button').click(function(e) {
//     e.preventDefault();
//
//     showThanksModal();
// });

$(function(){

    if(typeof landingData === 'undefined'){
        console.warn('landingData obj not found, ajax form will not work');
        return;
    }

    $('.callback-popup__form, .become-dealer__form').submit(function(e){

        e.preventDefault();

        if( ! $('#become-dealer-check').is(':checked')){
            return false;
        }

        var form = $(this);
        var data  = form.serialize();
        var url = landingData.ajaxUrl;

        data += '&nonce='  + landingData.nonce;
        data += '&action=' + landingData.action;

        console.log(url);
        console.log(data);

        $.ajax({
            type : 'POST',
            url : url, // admin-ajax.php URL
            data: data,
            error: function (request, status, error) {
                if( status === 500 ){
                    alert( 'Error while adding comment' );
                } else if( status === 'timeout' ){
                    alert('Error: Server doesn\'t respond.');
                } else {
                    // process WordPress errors
                    var wpErrorHtml = request.responseText.split("<p>"),
                        wpErrorStr = wpErrorHtml[1].split("</p>");
                    alert( wpErrorStr[0] );
                }
            },
            success: function ( httpResponse ) {
                if(httpResponse === 'success'){
                    showThanksModal();
                }
                else{
                    alert('Ошибка отправки формы');
                }
            },
            complete: function(){

            }
        });

    });


});